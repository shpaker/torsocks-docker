dist: trusty
services:
  - docker

stages:
- test
- name: deploy
  if: branch = master

jobs:
  include:
    - stage: test
      script:
        - docker build . -t torsocks:latest
        - docker run -d -p 9050:9050 torsocks
        - docker ps -a
        - sleep 10
        - docker logs --tail all $(docker ps -q --filter ancestor=torsocks)
        - curl -v -x socks5://127.0.0.1:9050 https://checkip.amazonaws.com
    - stage: deploy
      script:
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_LOGIN" --password-stdin
        - docker build . -t torsocks:latest
        - docker images
        - docker push ${DOCKER_REPO}
